mixin printChallenges(challenges, challengeType)
  each challenge in challenges
    .challenge
      p= challenge.name
      p #{challenge.date.start.toLocaleDateString()} - #{challenge.date.end.toLocaleDateString()}
      if challenge.winner
        p= "Winner: " + challenge.winner.name
      - let status
      if challengeType === "current"
        - status = challenge.participation ? {message: "Participating", color: "green"} : {message: "Not Participating", color: "grey"}
      else if challengeType === "future"
        if challenge.participation
          - status = { message: "Signed Up", color: "green" }
        else
          - status = { message: "Sign Up"}
          form.participate(action='/participations' method='POST')
            input(name="_id" type="hidden" value=challenge._id)
            input.grey-button(type='submit' value=status.message)
      else
        - status = challenge.participating ? { message: "Participated", color: "green" } : {message: "Did not Participate", color: "grey" }
      span.participation-status(class=status.color)= status.message

include ../layout.pug

block content
  .col-12
    .title Challenges

    if user.admin
      .center
        a.grey-button.add-challenge(href="/challenges/new") Create Challenge

    .subtitle Current Challenge
    .current-challenge
      if currentChallenge
        +printChallenges([currentChallenge], "current")
      else
        h3 There are no current challenges :( Contact your challenge administrator and request one!

    .subtitle.toggle-future-challenges Future Challenges (#{challengeCount}) #[span(class='down-arrow') &#9660;]
    .future-challenges
      if futureChallenges.length > 0
        +printChallenges(futureChallenges, "future")
      else
        h3 There aren't any scheduled challenges. Contact your program administrator and request one!


    .subtitle.toggle-past-challenges Past Challenges #[span(class='down-arrow') &#9660;]
    .past-challenges
      if pastChallenges.length > 0
        +printChallenges(pastChallenges, "past")
      else
        h3 This will fill up as soon as your organization starts competing!


append footer-scripts
  script.
    $(document).ready(function() {
      $('body').on('submit', '.participate', addParticipation);
    });

    function addParticipation(e) {
      e.preventDefault();
      var form = $(this);
      var data = form.serialize();

      var request = $.ajax({
        url: "/participations",
        type: "POST",
        data
      })

      request.done(function(res) {
        form.replaceWith("Signed Up");
      });

      request.fail(function(res) {
        console.log("Failed", res);
      })
    };

    $('body').on('click', '.subtitle.toggle-past-challenges', () => $('.past-challenges').slideToggle());
    $('body').on('click', '.subtitle.toggle-future-challenges', () => $('.future-challenges').slideToggle());